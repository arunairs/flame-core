import cn.blinkmind.flame.gradle.TaskGroup
import cn.blinkmind.flame.gradle.external.Redis

task redisEnv(group: TaskGroup.REDIS, dependsOn: ['componentEnv']) {
    ext.addRedis = { String name ->
        componentEnv.add(name, new Redis(name, project,
                new Redis.Settings(
                        homeDir: env.getRequiredString('REDIS_HOME'),
                        host: env.getRequiredString('REDIS_HOST'),
                        port: env.getRequiredInteger('REDIS_PORT'),
                        database: env.getRequiredInteger('REDIS_DATABASE'),
                        config: env.getString('REDIS_CONFIG')
                )))
    }

    ext.getRedis = { String name ->
        return componentEnv.get(name)
    }

    if (env.getString('REDIS_HOME')) {
        addRedis('build')
    }
}

task startRedis(group: TaskGroup.REDIS, dependsOn: ['redisEnv']) {
    doLast {
        Redis redis = redisEnv.getRedis('build')
        redis.start()
    }
}

task stopRedis(group: TaskGroup.REDIS, dependsOn: ['redisEnv']) {
    doLast {
        Redis redis = redisEnv.getRedis('build')
        redis.stop()
    }
}

task flushDB(group: TaskGroup.REDIS, dependsOn: ['redisEnv', 'startRedis']) {
    doLast {
        Redis redis = redisEnv.getRedis('build')
        redis.client.flushDB()
    }
}