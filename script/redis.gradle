import cn.blm.promise.buildtool.TaskGroup
import cn.blm.promise.buildtool.external.Redis

task redisEnv(group: TaskGroup.REDIS, dependsOn: [':externalEnv']) {
    ext.addRedis = { String name ->
        externalEnv.addComponent(name, new Redis(name, project,
                new Redis.Settings(
                        homeDir: env.getRequiredString('REDIS_HOME'),
                        host: env.getRequiredString('REDIS_HOST'),
                        port: env.getRequiredInteger('REDIS_PORT'),
                        database: env.getRequiredInteger('REDIS_DATABASE'),
                        config: env.getString('REDIS_CONFIG')
                )))
    }

    ext.getRedis = { String name ->
        return externalEnv.getComponent(name)
    }

    if (env.getString('REDIS_HOME')) {
        addRedis('redis')
    }
}

task startRedis(group: TaskGroup.REDIS, dependsOn: [':redisEnv']) << {
    Redis redis = redisEnv.getRedis('redis')
    redis.start()
}

task stopRedis(group: TaskGroup.REDIS, dependsOn: [':redisEnv']) << {
    Redis redis = redisEnv.getRedis('redis')
    redis.stop()
}

task flushDB(group: TaskGroup.REDIS, dependsOn: [':redisEnv', ':startRedis']) << {
    Redis redis = redisEnv.getRedis('redis')
    redis.client.flushDB()
}